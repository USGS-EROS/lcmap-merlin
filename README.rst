
[![Build Status](https://travis-ci.org/USGS-EROS/lcmap-merlin.svg?branch=develop)](https://travis-ci.org/USGS-EROS/lcmap-merlin)
$lcmap-merlin
=============

Turns lcmap spatial data into time series like magic.

Features
--------
* Retrieve chips & chip specs
* Convert chips & chip specs into time series rods
* Many composable functions
* Built with efficiency in mind... leverages Numpy for heavy lifting.
* Tested with cPython 3.5 & 3.6

Example
-------
This will retrieve pyccd flavored time-series data from an Aardvark instance
running locally on port 5678.
```
>>> from merlin import timeseries
>>> aardvark = 'http://localhost:5678'
>>> chips = '{}/{}'.format(aardvark, 'landsat/v1/chips')
>>> specs = '{}/{}'.format(aardvark, 'landsat/v1/chip-specs')
>>>
>>> def queries(url):
    return {'reds':     ''.join([url, '?q=tags:red AND sr']),
            'greens':   ''.join([url, '?q=tags:green AND sr']),
            'blues':    ''.join([url, '?q=tags:blue AND sr']),
            'nirs':     ''.join([url, '?q=tags:nir AND sr']),
            'swir1s':   ''.join([url, '?q=tags:swir1 AND sr']),
            'swir2s':   ''.join([url, '?q=tags:swir2 AND sr']),
            'thermals': ''.join([url, '?q=tags:bt AND thermal AND NOT tirs2']),
            'quality':  ''.join([url, '?q=tags:pixelqa'])}

>>> data = timeseries.pyccd(point=(-182000, 300400),
                            specs_url=specs,
                            chips_url=chips,
                            acquired='1980-01-01/2015-12-31',
                            queries=queries(specs)
>>> data
>>> (((chip_x, chip_y, x1, y1), {'dates': [],  'reds': [],     'greens': [],
                                 'blues': [],  'nirs1': [],    'swir1s': [],
                                 'swir2s': [], 'thermals': [], 'quality': []}),
     ((chip_x, chip_y, x1, y2), {'dates': [],  'reds': [],     'greens': [],
                                 'blues': [],  'nirs1': [],    'swir1s': [],
                                 'swir2s': [], 'thermals': [], 'quality': []}))
...
```
Version 1.0 will implement a check function instead, which will raise an
exception if all chip arrays are not symmetrical.

Installing
----------

From pypi: ```pip install lcmap-merlin```

Developing
----------
It is highly recommended to work within a virtual environment.
```bash
$ conda create --name merlin python=3.6
$ source activate merlin
```

From there, clone this repo and install merlin's dependencies.
```bash
$ git clone git@github.com:usgs-eros/lcmap-merlin
$ cd lcmap-merlin
$ pip install -e .[test]
```

Testing
-------
```bash
$ pytest
```

Occasionally chip and chip spec test data may need to be updated if the source
specifications change.

Execute ```data.update_specs()``` and ```data.update_chips()``` from a repl.
The date range and spatial location of the data may be altered
in ```merlin/support/__init__.py```.  When expanding the data query date range,
please note that PyPi has a limit of 60MB per artifact.  Uploads exceeding this
limit will result in failure messages while publishing.
```
>>> specs_url = 'http://localhost:5678/v1/landsat/chip-specs'
>>> chips_url = 'http://localhost:5678/v1/landsat/chips'
>>>
>>> from merlin.support import data
>>> data.update_specs(specs_url=specs_url)
>>> data.update_chips(chips_url=chips_url, specs_url=specs_url)
```


Exception: assymetric dates detected - thermals != quality
E           thermals('2012-01-07T18:43:29Z', '2012-01-16T18:37:18Z', '2012-01-23T18:43:27Z', '2012-02-01T18:37:45Z', '2012-02-17T18:37:25Z', '2012-02-24T18:43:36Z', '2012-03-04T18:37:23Z', '2012-03-11T18:43:34Z', '2012-03-20T18:37:25Z', '2012-04-05T18:37:22Z', '2012-04-12T18:43:30Z', '2012-04-21T18:37:29Z', '2012-04-28T18:43:51Z', '2012-05-07T18:37:53Z', '2012-05-14T18:44:12Z', '2012-05-23T18:37:54Z', '2012-05-30T18:43:55Z', '2012-06-08T18:38:02Z', '2012-06-15T18:43:53Z', '2012-06-24T18:37:46Z', '2012-07-01T18:44:02Z', '2012-07-10T18:38:01Z', '2012-07-26T18:38:11Z', '2012-08-02T18:44:26Z', '2012-08-11T18:38:23Z', '2012-08-18T18:44:38Z', '2012-08-27T18:38:32Z', '2012-09-03T18:44:48Z', '2012-09-12T18:38:42Z', '2012-09-19T18:44:56Z', '2012-09-28T18:38:52Z', '2012-10-05T18:45:06Z', '2012-10-14T18:39:24Z', '2012-10-21T18:45:16Z', '2012-11-06T18:45:18Z', '2012-11-22T18:45:27Z', '2012-12-01T18:39:16Z', '2012-12-08T18:45:29Z', '2012-12-17T18:39:47Z', '2012-12-24T18:45:37Z', '2013-01-09T18:45:37Z', '2013-02-03T18:39:54Z', '2013-02-10T18:45:41Z', '2013-02-19T18:39:28Z', '2013-02-26T18:45:36Z', '2013-03-07T18:39:26Z', '2013-03-23T18:39:21Z', '2013-04-08T18:39:19Z', '2013-04-24T18:39:11Z', '2013-05-01T18:45:23Z', '2013-05-10T18:39:09Z', '2013-05-17T18:45:20Z', '2013-05-26T18:39:06Z', '2013-06-02T18:45:11Z', '2013-06-11T18:38:58Z', '2013-06-18T18:45:06Z', '2013-06-27T18:38:51Z', '2013-07-04T18:44:57Z', '2013-07-13T18:38:40Z', '2013-07-20T18:44:49Z', '2013-07-29T18:38:33Z', '2013-08-05T18:44:43Z', '2013-08-14T18:38:33Z', '2013-08-30T18:38:45Z', '2013-09-15T18:38:56Z', '2013-09-22T18:45:10Z', '2013-10-01T18:39:06Z', '2013-10-08T18:45:24Z', '2013-10-17T18:39:19Z', '2013-10-24T18:45:32Z', '2013-11-02T18:39:23Z', '2013-11-09T18:45:38Z', '2013-11-25T18:45:43Z', '2013-12-04T18:39:37Z', '2013-12-11T18:45:49Z', '2014-01-05T18:39:44Z', '2014-01-12T18:45:59Z', '2014-02-06T18:40:10Z', '2014-02-13T18:46:15Z', '2014-02-22T18:40:00Z', '2014-03-10T18:40:06Z', '2014-03-17T18:46:21Z', '2014-03-26T18:40:13Z', '2014-04-02T18:46:27Z', '2014-04-11T18:40:19Z', '2014-04-18T18:46:36Z', '2014-04-27T18:40:30Z', '2014-05-13T18:40:36Z', '2014-05-20T18:46:49Z', '2014-05-29T18:40:40Z', '2014-06-05T18:46:52Z', '2014-06-14T18:41:05Z', '2014-06-21T18:46:54Z', '2014-06-30T18:40:47Z', '2014-07-07T18:46:59Z', '2014-07-16T18:40:48Z', '2014-07-23T18:47:03Z', '2014-08-01T18:41:19Z', '2014-08-08T18:47:07Z', '2014-08-17T18:40:56Z', '2014-08-24T18:47:05Z', '2014-09-02T18:40:55Z', '2014-09-18T18:40:59Z', '2014-10-04T18:41:12Z', '2014-10-11T18:47:25Z', '2014-10-20T18:41:20Z', '2014-10-27T18:47:34Z', '2014-11-12T18:47:43Z', '2014-11-28T18:47:48Z', '2014-12-07T18:41:41Z', '2013-03-25T18:51:44Z', '2013-04-16T18:45:06Z', '2013-04-23T18:51:14Z', '2013-05-25T18:51:31Z', '2013-06-03T18:45:20Z', '2013-06-10T18:51:28Z', '2013-06-19T18:45:13Z', '2013-06-26T18:51:25Z', '2013-07-05T18:45:16Z', '2013-07-12T18:51:27Z', '2013-07-21T18:45:14Z', '2013-07-28T18:51:27Z', '2013-08-06T18:45:18Z', '2013-08-13T18:51:28Z', '2013-08-22T18:45:19Z', '2013-08-29T18:51:31Z', '2013-09-07T18:45:18Z', '2013-09-14T18:51:27Z', '2013-09-23T18:45:11Z', '2013-09-30T18:51:21Z', '2013-10-09T18:45:10Z', '2013-10-16T18:51:19Z', '2013-10-25T18:45:02Z', '2013-11-01T18:51:12Z', '2013-11-10T18:45:01Z', '2013-11-17T18:51:08Z', '2013-11-26T18:44:54Z', '2013-12-03T18:51:05Z', '2013-12-12T18:44:51Z', '2013-12-19T18:50:55Z', '2013-12-28T18:44:42Z', '2014-01-04T18:50:49Z', '2014-01-13T18:44:28Z', '2014-01-20T18:50:36Z', '2014-01-29T18:44:22Z', '2014-02-05T18:50:28Z', '2014-02-14T18:44:08Z', '2014-02-21T18:50:15Z', '2014-03-02T18:43:52Z', '2014-03-09T18:50:01Z', '2014-03-18T18:43:44Z', '2014-03-25T18:49:46Z', '2014-04-03T18:43:29Z', '2014-04-10T18:49:32Z', '2014-04-19T18:43:12Z', '2014-04-26T18:49:17Z', '2014-05-05T18:42:55Z', '2014-05-12T18:49:03Z', '2014-05-21T18:42:47Z', '2014-05-28T18:49:02Z', '2014-06-06T18:42:57Z', '2014-06-13T18:49:10Z', '2014-06-22T18:43:00Z', '2014-06-29T18:49:13Z', '2014-07-08T18:43:08Z', '2014-07-15T18:49:20Z', '2014-07-24T18:43:10Z', '2014-07-31T18:49:26Z', '2014-08-09T18:43:19Z', '2014-08-16T18:49:32Z', '2014-08-25T18:43:22Z', '2014-09-01T18:49:34Z', '2014-09-10T18:43:26Z', '2014-09-17T18:49:36Z', '2014-09-26T18:43:23Z', '2014-10-03T18:49:39Z', '2014-10-12T18:43:30Z', '2014-10-19T18:49:42Z', '2014-10-28T18:43:27Z', '2014-11-04T18:49:41Z', '2014-11-13T18:43:31Z', '2014-11-20T18:49:37Z', '2014-11-29T18:43:29Z', '2014-12-06T18:49:37Z')
E           quality('2012-01-05T18:55:51Z', '2012-01-07T18:43:29Z', '2012-01-14T18:50:04Z', '2012-01-16T18:37:18Z', '2012-01-23T18:43:27Z', '2012-01-30T18:50:05Z', '2012-02-01T18:37:45Z', '2012-02-06T18:55:55Z', '2012-02-15T18:49:23Z', '2012-02-17T18:37:25Z', '2012-02-22T18:55:58Z', '2012-02-24T18:43:36Z', '2012-03-04T18:37:23Z', '2012-03-11T18:43:34Z', '2012-03-18T18:49:22Z', '2012-03-20T18:37:25Z', '2012-03-25T18:55:57Z', '2012-04-05T18:37:22Z', '2012-04-10T18:55:51Z', '2012-04-12T18:43:30Z', '2012-04-19T18:49:22Z', '2012-04-21T18:37:29Z', '2012-04-26T18:56:10Z', '2012-04-28T18:43:51Z', '2012-05-07T18:37:53Z', '2012-05-12T18:56:32Z', '2012-05-14T18:44:12Z', '2012-05-23T18:37:54Z', '2012-05-28T18:56:20Z', '2012-05-30T18:43:55Z', '2012-06-06T18:49:34Z', '2012-06-08T18:38:02Z', '2012-06-15T18:43:53Z', '2012-06-24T18:37:46Z', '2012-07-01T18:44:02Z', '2012-07-08T18:49:57Z', '2012-07-10T18:38:01Z', '2012-07-24T18:50:08Z', '2012-07-26T18:38:11Z', '2012-07-31T18:56:45Z', '2012-08-02T18:44:26Z', '2012-08-09T18:50:19Z', '2012-08-11T18:38:23Z', '2012-08-16T18:56:58Z', '2012-08-18T18:44:38Z', '2012-08-25T18:50:28Z', '2012-08-27T18:38:32Z', '2012-09-01T18:57:08Z', '2012-09-03T18:44:48Z', '2012-09-10T18:50:39Z', '2012-09-12T18:38:42Z', '2012-09-17T18:57:16Z', '2012-09-19T18:44:56Z', '2012-09-26T18:50:49Z', '2012-09-28T18:38:52Z', '2012-10-03T18:57:27Z', '2012-10-05T18:45:06Z', '2012-10-12T18:51:20Z', '2012-10-14T18:39:24Z', '2012-10-21T18:45:16Z', '2012-10-28T18:51:29Z', '2012-11-06T18:45:18Z', '2012-11-22T18:45:27Z', '2012-12-01T18:39:16Z', '2012-12-08T18:45:29Z', '2012-12-17T18:39:47Z', '2012-12-22T18:57:58Z', '2012-12-24T18:45:37Z', '2013-01-09T18:45:37Z', '2013-01-16T18:51:24Z', '2013-02-01T18:51:52Z', '2013-02-03T18:39:54Z', '2013-02-08T18:58:02Z', '2013-02-10T18:45:41Z', '2013-02-17T18:51:50Z', '2013-02-19T18:39:28Z', '2013-02-26T18:45:36Z', '2013-03-07T18:39:26Z', '2013-03-21T18:51:44Z', '2013-03-23T18:39:21Z', '2013-03-28T18:57:52Z'
